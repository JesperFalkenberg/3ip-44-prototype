<!DOCTYPE html>
<html>
    <head>
        <style>
            *{
                margin: 0;
                padding: 0;
                font-family: 'poppins', sans-serif;
                box-sizing: border-box;
                overflow: hidden;
            }
            .hero{
                background: #fff;
                min-height: 100vh;
                width: 100%;
                color: #000;
                position: relative;
            }
            .hero table{
                margin: 0;
            	border-color: #000;
	            border-collapse: separate;
	            border-radius: 5px;
	            text-align: left;
	            background-color: #dedede;
                height: 100%;
                width: 100%;
            }
            .hero table th{
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
            }
            .hero table tr img{
                height: 25px;
                width: 25px;
            }
            .hero table th:last-child{
	            border-right: 0;
            }
            .hero table td, tr{
                padding: 5px 0;
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
            }
            .hero table td:first-child, tr:first-child{
                padding-right: 5px;
            }
            .hero table td:last-child, tr:last-child{
	            border-right: 0px;
            }
        </style>
    </head>
    <body onload="con() && fetchEverything() && putValues()">
        <div class="hero">
            <table>
                <tr>
                    <th></th>
                    <th>This product</th>
                    <th>AVG product</th>
                    <th>Compared</th>
                </tr>
                <tr>
                    <td>
                        <img src="img\CO2 Footprint Color.png" alt="">
                    </td>
                    <td id="co2-this"></td>
                    <td id="co2-avg"></td>
                    <td id="co2-pct"></td>
                </tr>
                <tr>
                    <td>
                        <img src="img\Transport Color.png" alt="">
                    </td>
                    <td id="transport-this"></td>
                    <td id="transport-avg"></td>
                    <td id="transport-pct"></td>
                </tr>
                <tr>
                    <td>
                        <img src="img\Water Drop Color.png" alt="">
                    </td>
                    <td id="water-this"></td>
                    <td id="water-avg"></td>
                    <td id="water-pct"></td>
                </tr>
            </table>
        </div>
        <script>
            function con(){
                // FETCHING DATA
                const mysql = require('mysql');
                const connection = mysql.createConnection({
                    host: 'localhost',
                    user: 'root',
                    password: '1234',
                    database: 'despiteProducts'
                });
                connection.connect((err) => {
                    if (err) {
                        console.log('Error connectin to database.');
                        return;
                    };
                    console.log('Connected!');
                });
                connection.end((err) => {
                    // graceful teardown
                });
            }

            // product related info
            var productName = 'KortÃ¦rmet T-shirt | Black/Royal Blue';
            var productType, productId;
            var avgCO2, avgTransport, avgWater;
            var CO2 = [0,0,0,0,0,0];
            var transport = [0,0,0,0,0,0];
            var water = [0,0,0,0,0,0];
            var CO2_lit, transport_lit, water_lit;
            // get product data and calc pcts
            function fetchEverything(){
                // product and type
                connection.query(`SELECT * FROM products WHERE name = \'${productName}\'`, (err, rows) => {
                    if(err) throw err;
                    rows.forEach((r) => {
                        productType = rows.productType;
                        productId = rows.id;
                    });
                });
                // avg vals for product type
                connection.query(`SELECT * FROM averages WHERE productType =\'${productType}\'`, (err, rows) =>{
                    avgCO2 = rows.CO2;
                    avgTransport = rows.transport;
                    avgWater = rows.water;
                });
                // step vals
                for (var i = 0; i < 6; i++) {
                    connection.query(`SELECT * FROM stepValues WHERE productId = \'${productId}\' AND stepNum = \'${i+1}\'`, (err, rows) =>{
                        CO2[i] = rows.CO2;
                        transport[i] = rows.transport;
                        water[i] = rows.water;
                    });
                }
                /// calcs
                // sum steps
                for(i = 0; i < 6; i++){
                    for(j = 0; j < i; j++){
                        CO2[i] += CO2[j];
                        transport[i] += transport[j];
                        water[i] += transport[j];
                    }
                }
                CO2_lit = CO2[5]; transport_lit = transport[5]; water_lit = water[5];

                // calc pct
                for(i = 0; i < 6; i++){
                    CO2[i] = CO2[i] * 100 / avgCO2;
                    transport[i] = transport[i] * 100 / avgTransport;
                    water[i] = water[i] * 100 / avgWater;
                }
            }

            function putValues(){
                changeDesc('co2-this', CO2_lit); changeDesc('transport-this', transport_lit); changeDesc('water-this', water_lit);
                changeDesc('co2-avg', avgCO2); changeDesc('transport-avg', avgTransport); changeDesc('water-avg', avgWater);
                changeDesc('co2-pct', CO2[5] + '%'); 
                changeDesc('transport-pct', transport[5] + '%'); 
                changeDesc('water-pct', water[5] + '%');
            }

            function changeDesc(elem, newText){
                document.getElementById(elem).innerText = newText;
            }

        </script>
    </body>
</html>